from twisted.internet.protocol import Factory, Protocol
from twisted.internet import reactor
from request import *
class IphoneChat(Protocol):
    def connectionMade(self):
        self.factory.clients.append(self)
        print "clients are ", self.factory.clients
 
    def connectionLost(self, reason):
        self.factory.clients.remove(self)
    def GenerateResults(self,a):
        print "request accepted",a
        if len(a.strip())<3:
            return None
        if a.strip()=="test":
            return "[{\"flights\": [{\"arrival\": \"2015-10-10T14:01-04:00\", \"to\": \"CLT\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T06:00-07:00\"}, {\"arrival\": \"2015-10-10T17:58-04:00\", \"to\": \"PIT\", \"fr\": \"CLT\", \"depature\": \"2015-10-10T16:30-04:00\"}], \"total\": \"1. USD174.10\"}, {\"flights\": [{\"arrival\": \"2015-10-10T14:01-04:00\", \"to\": \"CLT\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T06:00-07:00\"}, {\"arrival\": \"2015-10-10T16:17-04:00\", \"to\": \"PIT\", \"fr\": \"CLT\", \"depature\": \"2015-10-10T14:50-04:00\"}], \"total\": \"2. USD174.10\"}, {\"flights\": [{\"arrival\": \"2015-10-11T06:12-04:00\", \"to\": \"PHL\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T22:00-07:00\"}, {\"arrival\": \"2015-10-11T11:11-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-11T09:50-04:00\"}], \"total\": \"3. USD175.60\"}, {\"flights\": [{\"arrival\": \"2015-10-11T06:12-04:00\", \"to\": \"PHL\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T22:00-07:00\"}, {\"arrival\": \"2015-10-11T08:58-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-11T07:40-04:00\"}], \"total\": \"4. USD175.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:35-07:00\", \"to\": \"SNA\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:00-07:00\"}, {\"arrival\": \"2015-10-10T17:55-05:00\", \"to\": \"IAH\", \"fr\": \"SNA\", \"depature\": \"2015-10-10T12:40-07:00\"}, {\"arrival\": \"2015-10-10T23:03-04:00\", \"to\": \"PIT\", \"fr\": \"IAH\", \"depature\": \"2015-10-10T19:10-05:00\"}], \"total\": \"5. USD256.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:53-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:25-07:00\"}, {\"arrival\": \"2015-10-10T16:50-05:00\", \"to\": \"IAH\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T11:30-07:00\"}, {\"arrival\": \"2015-10-10T23:03-04:00\", \"to\": \"PIT\", \"fr\": \"IAH\", \"depature\": \"2015-10-10T19:10-05:00\"}], \"total\": \"6. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T11:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T10:30-07:00\"}, {\"arrival\": \"2015-10-10T22:03-04:00\", \"to\": \"PHL\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T13:50-07:00\"}, {\"arrival\": \"2015-10-10T23:59-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-10T22:54-04:00\"}], \"total\": \"7. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:53-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:25-07:00\"}, {\"arrival\": \"2015-10-10T21:03-04:00\", \"to\": \"CLT\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T13:15-07:00\"}, {\"arrival\": \"2015-10-10T23:26-04:00\", \"to\": \"PIT\", \"fr\": \"CLT\", \"depature\": \"2015-10-10T22:09-04:00\"}], \"total\": \"8. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:53-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:25-07:00\"}, {\"arrival\": \"2015-10-10T17:54-05:00\", \"to\": \"IAH\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T12:30-07:00\"}, {\"arrival\": \"2015-10-10T23:03-04:00\", \"to\": \"PIT\", \"fr\": \"IAH\", \"depature\": \"2015-10-10T19:10-05:00\"}], \"total\": \"9. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T11:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T10:30-07:00\"}, {\"arrival\": \"2015-10-10T21:03-04:00\", \"to\": \"CLT\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T13:15-07:00\"}, {\"arrival\": \"2015-10-10T23:26-04:00\", \"to\": \"PIT\", \"fr\": \"CLT\", \"depature\": \"2015-10-10T22:09-04:00\"}], \"total\": \"10. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T08:50-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T07:30-07:00\"}, {\"arrival\": \"2015-10-10T19:16-04:00\", \"to\": \"PHL\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T11:00-07:00\"}, {\"arrival\": \"2015-10-10T21:47-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-10T20:33-04:00\"}], \"total\": \"11. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T08:50-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T07:30-07:00\"}, {\"arrival\": \"2015-10-10T19:06-04:00\", \"to\": \"CLT\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T11:20-07:00\"}, {\"arrival\": \"2015-10-10T21:10-04:00\", \"to\": \"PIT\", \"fr\": \"CLT\", \"depature\": \"2015-10-10T19:50-04:00\"}], \"total\": \"12. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T11:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T10:30-07:00\"}, {\"arrival\": \"2015-10-10T17:54-05:00\", \"to\": \"IAH\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T12:30-07:00\"}, {\"arrival\": \"2015-10-10T23:03-04:00\", \"to\": \"PIT\", \"fr\": \"IAH\", \"depature\": \"2015-10-10T19:10-05:00\"}], \"total\": \"13. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T08:50-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T07:30-07:00\"}, {\"arrival\": \"2015-10-10T14:05-07:00\", \"to\": \"PHX\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T12:40-07:00\"}, {\"arrival\": \"2015-10-10T21:57-04:00\", \"to\": \"PIT\", \"fr\": \"PHX\", \"depature\": \"2015-10-10T14:55-07:00\"}], \"total\": \"14. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:53-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:25-07:00\"}, {\"arrival\": \"2015-10-10T14:05-07:00\", \"to\": \"PHX\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T12:40-07:00\"}, {\"arrival\": \"2015-10-10T21:57-04:00\", \"to\": \"PIT\", \"fr\": \"PHX\", \"depature\": \"2015-10-10T14:55-07:00\"}], \"total\": \"15. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T08:50-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T07:30-07:00\"}, {\"arrival\": \"2015-10-10T16:06-05:00\", \"to\": \"DFW\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T10:55-07:00\"}, {\"arrival\": \"2015-10-10T22:09-04:00\", \"to\": \"PIT\", \"fr\": \"DFW\", \"depature\": \"2015-10-10T18:20-05:00\"}], \"total\": \"16. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:53-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:25-07:00\"}, {\"arrival\": \"2015-10-10T22:03-04:00\", \"to\": \"PHL\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T13:50-07:00\"}, {\"arrival\": \"2015-10-10T23:59-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-10T22:54-04:00\"}], \"total\": \"17. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T08:50-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T07:30-07:00\"}, {\"arrival\": \"2015-10-10T14:54-05:00\", \"to\": \"IAH\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T09:30-07:00\"}, {\"arrival\": \"2015-10-10T19:35-04:00\", \"to\": \"PIT\", \"fr\": \"IAH\", \"depature\": \"2015-10-10T15:40-05:00\"}], \"total\": \"18. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T11:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T10:30-07:00\"}, {\"arrival\": \"2015-10-10T20:55-05:00\", \"to\": \"ORD\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T14:43-07:00\"}, {\"arrival\": \"2015-10-11T00:10-04:00\", \"to\": \"PIT\", \"fr\": \"ORD\", \"depature\": \"2015-10-10T21:40-05:00\"}], \"total\": \"19. USD258.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T11:10-07:00\", \"to\": \"SEA\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T09:00-07:00\"}, {\"arrival\": \"2015-10-10T20:55-04:00\", \"to\": \"IAD\", \"fr\": \"SEA\", \"depature\": \"2015-10-10T13:07-07:00\"}, {\"arrival\": \"2015-10-10T23:00-04:00\", \"to\": \"PIT\", \"fr\": \"IAD\", \"depature\": \"2015-10-10T22:00-04:00\"}], \"total\": \"20. USD269.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T19:26-07:00\", \"to\": \"SAN\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T18:00-07:00\"}, {\"arrival\": \"2015-10-11T06:19-04:00\", \"to\": \"PHL\", \"fr\": \"SAN\", \"depature\": \"2015-10-10T22:15-07:00\"}, {\"arrival\": \"2015-10-11T08:58-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-11T07:40-04:00\"}], \"total\": \"21. USD271.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T08:50-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T07:30-07:00\"}, {\"arrival\": \"2015-10-10T14:23-06:00\", \"to\": \"DEN\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T11:02-07:00\"}, {\"arrival\": \"2015-10-10T20:32-04:00\", \"to\": \"PIT\", \"fr\": \"DEN\", \"depature\": \"2015-10-10T15:30-06:00\"}], \"total\": \"22. USD278.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T10:03-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T08:30-07:00\"}, {\"arrival\": \"2015-10-10T14:05-07:00\", \"to\": \"PHX\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T12:40-07:00\"}, {\"arrival\": \"2015-10-10T21:57-04:00\", \"to\": \"PIT\", \"fr\": \"PHX\", \"depature\": \"2015-10-10T14:55-07:00\"}], \"total\": \"23. USD292.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T20:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T19:30-07:00\"}, {\"arrival\": \"2015-10-11T06:02-05:00\", \"to\": \"ORD\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T23:59-07:00\"}, {\"arrival\": \"2015-10-11T09:37-04:00\", \"to\": \"PIT\", \"fr\": \"ORD\", \"depature\": \"2015-10-11T07:10-05:00\"}], \"total\": \"24. USD292.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T20:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T19:30-07:00\"}, {\"arrival\": \"2015-10-11T07:25-04:00\", \"to\": \"IAD\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T23:30-07:00\"}, {\"arrival\": \"2015-10-11T09:30-04:00\", \"to\": \"PIT\", \"fr\": \"IAD\", \"depature\": \"2015-10-11T08:30-04:00\"}], \"total\": \"25. USD292.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T20:54-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T19:30-07:00\"}, {\"arrival\": \"2015-10-11T06:20-04:00\", \"to\": \"PHL\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T22:15-07:00\"}, {\"arrival\": \"2015-10-11T08:58-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-11T07:40-04:00\"}], \"total\": \"26. USD292.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T12:49-07:00\", \"to\": \"LAX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T11:30-07:00\"}, {\"arrival\": \"2015-10-10T20:55-05:00\", \"to\": \"ORD\", \"fr\": \"LAX\", \"depature\": \"2015-10-10T14:43-07:00\"}, {\"arrival\": \"2015-10-11T00:10-04:00\", \"to\": \"PIT\", \"fr\": \"ORD\", \"depature\": \"2015-10-10T21:40-05:00\"}], \"total\": \"27. USD292.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T09:58-07:00\", \"to\": \"PDX\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T08:15-07:00\"}, {\"arrival\": \"2015-10-10T16:42-05:00\", \"to\": \"ORD\", \"fr\": \"PDX\", \"depature\": \"2015-10-10T10:42-07:00\"}, {\"arrival\": \"2015-10-10T20:01-04:00\", \"to\": \"PIT\", \"fr\": \"ORD\", \"depature\": \"2015-10-10T17:30-05:00\"}], \"total\": \"28. USD295.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T20:33-07:00\", \"to\": \"LAS\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T19:00-07:00\"}, {\"arrival\": \"2015-10-11T05:59-04:00\", \"to\": \"PHL\", \"fr\": \"LAS\", \"depature\": \"2015-10-10T22:20-07:00\"}, {\"arrival\": \"2015-10-11T08:58-04:00\", \"to\": \"PIT\", \"fr\": \"PHL\", \"depature\": \"2015-10-11T07:40-04:00\"}], \"total\": \"29. USD303.60\"}, {\"flights\": [{\"arrival\": \"2015-10-10T20:33-07:00\", \"to\": \"LAS\", \"fr\": \"SFO\", \"depature\": \"2015-10-10T19:00-07:00\"}, {\"arrival\": \"2015-10-11T05:28-05:00\", \"to\": \"ORD\", \"fr\": \"LAS\", \"depature\": \"2015-10-10T23:59-07:00\"}, {\"arrival\": \"2015-10-11T09:37-04:00\", \"to\": \"PIT\", \"fr\": \"ORD\", \"depature\": \"2015-10-11T07:10-05:00\"}], \"total\": \"30. USD303.60\"}]\n"
        arrs=a.replace("\n","").split(":")
        google_json=GetPriceJson("request_template.json",arrs[0],arrs[1],arrs[2],"AIzaSyBdVobWYnDYRKuyUs2yVXnQM0bP97EjUTQ")
        json_string=ProcessPriceJson(google_json)
        return json_string
    def dataReceived(self, data):
        send_msg=self.GenerateResults(data)
        if send_msg!=None:
            print send_msg
            for c in self.factory.clients:
                c.message(send_msg)
            # self.factory.clients.remove(self)
        self.transport.loseConnection()
        # reactor.loseConnection()

    def message(self, message):
        self.transport.write(message + '\n')
factory = Factory()
factory.protocol = IphoneChat
factory.clients = []
reactor.listenTCP(5999, factory)
print "Airfare server started"
reactor.run()
